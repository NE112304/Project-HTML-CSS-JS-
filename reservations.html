<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réservations - Gestion de Restaurant</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>RestoManager</h2>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="plats.html">Plats (Menu)</a></li>
                    <li><a href="commandes.html">Commandes</a></li>
                    <li><a href="tables.html">Tables</a></li>
                    <li><a href="reservations.html" class="active">Réservations</a></li>
                    <li><a href="employes.html">Employés</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                &copy; 2026 Restaurant
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1>Gestion des Réservations</h1>
                <button class="btn btn-primary" onclick="openModal()">
                    <span>+</span> Nouvelle Réservation
                </button>
            </header>

            <!-- Table -->
            <div class="table-container">
                <table id="reservationsTable">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Date & Heure</th>
                            <th>Nombre de personnes</th>
                            <th>Table</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal Form -->
    <div id="reservationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nouvelle Réservation</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <form id="reservationForm">
                <input type="hidden" id="reservationId">
                <div class="form-group">
                    <label for="client">Nom du Client</label>
                    <input type="text" id="client" required>
                </div>
                <div class="form-group">
                    <label for="date">Date et Heure</label>
                    <input type="datetime-local" id="date" required>
                </div>
                <div class="form-group">
                    <label for="personnes">Nombre de personnes</label>
                    <input type="number" id="personnes" min="1" required>
                </div>
                <div class="form-group">
                    <label for="tableSelect">Table (Optionnel)</label>
                    <select id="tableSelect">
                        <option value="">-- Assigner une table plus tard --</option>
                    </select>
                </div>
                <div class="text-right mt-4">
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="btn btn-success">Sauvegarder</button>
                </div>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // DOM Elements
        const modal = document.getElementById('reservationModal');
        const form = document.getElementById('reservationForm');
        const tableBody = document.querySelector('#reservationsTable tbody');
        const modalTitle = document.getElementById('modalTitle');
        const tableSelect = document.getElementById('tableSelect');

        // Render functions
        function renderTable() {
            const reservations = DataManager.getAll(STORAGE_KEYS.RESERVATIONS);
            // Sort: Upcoming first
            reservations.sort((a, b) => new Date(a.date) - new Date(b.date));

            tableBody.innerHTML = reservations.map(res => `
                <tr>
                    <td><strong>${res.client}</strong></td>
                    <td>${new Date(res.date).toLocaleString('fr-FR')}</td>
                    <td>${res.personnes}</td>
                    <td>${res.tableName || '<span style="color:var(--text-light)">Non assignée</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editReservation(${res.id})">Modifier</button>
                        <button class="btn btn-sm btn-info" onclick="viewDetails(${res.id})">Informations</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteReservation(${res.id})">Supprimer</button>
                    </td>
                </tr>
            `).join('');
        }

        function populateTableSelect() {
            const tables = DataManager.getAll(STORAGE_KEYS.TABLES);
            // Keep existing options logic + add dynamic
            const defaultOption = '<option value="">-- Assigner une table plus tard --</option>';
            const options = tables.map(t => `<option value="${t.id}" data-name="${t.numero}">${t.numero} (Cap: ${t.capacite})</option>`).join('');
            tableSelect.innerHTML = defaultOption + options;
        }

        // Modal functions
        function openModal(isEdit = false) {
            modal.classList.add('active');
            modalTitle.textContent = isEdit ? 'Modifier la Réservation' : 'Nouvelle Réservation';
            populateTableSelect();
            if (!isEdit) {
                form.reset();
                document.getElementById('reservationId').value = '';
            }
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        function viewDetails(id) {
            const reservations = DataManager.getAll(STORAGE_KEYS.RESERVATIONS);
            const res = reservations.find(r => r.id === id);
            if (res) {
                // Format for display
                const displayData = { ...res };
                if (displayData.date) displayData.date = new Date(displayData.date).toLocaleString('fr-FR');
                openDetailsModal('Détails de la Réservation', displayData);
            }
        }

        // CRUD Operations
        function editReservation(id) {
            const reservations = DataManager.getAll(STORAGE_KEYS.RESERVATIONS);
            const res = reservations.find(r => r.id === id);
            if (res) {
                openModal(true);
                document.getElementById('reservationId').value = res.id;
                document.getElementById('client').value = res.client;
                document.getElementById('date').value = res.date;
                document.getElementById('personnes').value = res.personnes;
                document.getElementById('tableSelect').value = res.tableId || '';
            }
        }

        function deleteReservation(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette réservation ?')) {
                DataManager.delete(STORAGE_KEYS.RESERVATIONS, id);
                renderTable();
            }
        }

        // Form Submit
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('reservationId').value;
            const tableId = document.getElementById('tableSelect').value;
            let tableName = '';

            if (tableId) {
                const selectedOption = tableSelect.options[tableSelect.selectedIndex];
                tableName = selectedOption.getAttribute('data-name');
            }

            const reservationData = {
                id: id ? parseInt(id) : null,
                client: document.getElementById('client').value,
                date: document.getElementById('date').value,
                personnes: parseInt(document.getElementById('personnes').value),
                tableId: tableId ? parseInt(tableId) : null,
                tableName: tableName
            };

            if (id) {
                DataManager.update(STORAGE_KEYS.RESERVATIONS, reservationData);
            } else {
                DataManager.add(STORAGE_KEYS.RESERVATIONS, reservationData);
            }

            closeModal();
            renderTable();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();

            // Check for URL params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'new') {
                openModal();
            }
        });
        window.onclick = (event) => {
            if (event.target == modal) closeModal();
        };
    </script>
</body>

</html>